ALTER TABLE gam.[Session] ADD [SesOauthScope]  nvarchar(1024) NULL , [SesOauthTokenExpires]  int NULL , [SesOauthTokenMaxRenew]  smallint NULL , [SesAutTypeName]  nchar(60) NULL , [SesExtToken2]  nvarchar(1024) NULL

ALTER TABLE gam.[SessionHistory] ADD [SesHisOauthScope]  nvarchar(1024) NULL , [SesHisOauthTokenExpires]  int NULL , [SesHisOauthTokenMaxRenew]  smallint NULL , [SesHisAppTokenExp]  datetime NULL , [SesHisDeviceId]  nchar(40) NULL , [SesHisRefreshToken]  nchar(40) NULL , [SesHisAppId]  decimal( 12) NULL , [SesHisExtToken2]  nvarchar(1024) NULL

ALTER TABLE gam.[Application] ADD [AppCliLocalLoginURL]  nvarchar(1024) NULL , [AppCliAllowGetUserAdditionalDa]  BIT NULL , [AppCliAllowGetUserRoles]  BIT NULL , [AppCliAllowRemoteAuth]  BIT NULL
INSERT INTO gam.[Repository] ([RepId], [RepVer], [RepUpg], [RepDefAutTypeName], [RepUserActType], [RepUserActTimeOut], [RepDefSecPolId], [RepGenAud], [RepUserRemMeTimeOut], [RepGenSesSta], [RepUserChrMinLog], [RepGUID], [RepCanRegUser], [RepUserRemMeType], [RepGiveAnoSes], [RepAnoUserGUID], [RepDefRoleId], [RepCreDate], [RepCreUser], [RepUpdDate], [RepUpdUser], [RepNameSpace], [RepUserRecPwdKeyTimeOut], [RepUserReqPwd], [RepUserReqEmail], [RepUserReqFirstName], [RepUserReqLastName], [RepUserReqBir], [RepUserReqGen], [RepUserReqPhone], [RepUserReqAddress], [RepUserReqCity], [RepUserReqState], [RepUserReqCountry], [RepUserReqPostCode], [RepUserReqLng], [RepUserReqTimeZone], [RepUserReqPhoto], [RepUserAttLogLockUser], [RepUserAttLogLockSession], [RepDsc], [RepUserEmailSecAdm], [RepUserTimeToUnblock], [RepName], [RepUserEmailUnique], [RepAllowOauthAccess], [RepUserIdentification], [RepKeepSesOnlyOriIP], [RepUserSessionCacheTimeout], [RepAnoUserSDRoleId]) SELECT DISTINCT [RepId], ' ', ' ', NULL, 'A', 36, NULL, 'None', 0, 'None', 3, ' ', convert(bit, 0), ' ', convert(bit, 0), NULL, NULL, convert( DATETIME, '1753-1-1 0:0:0', 120), ' ', convert( DATETIME, '17530101', 112 ), ' ', ' ', 120, convert(int, 1), convert(int, 1), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), convert(bit, 0), 8, 10, NULL, NULL, 30, ' ', convert(bit, 0), convert(int, 1), 'name', convert(bit, 0), 60, NULL FROM gam.[Application] T WHERE NOT EXISTS (SELECT 1 FROM gam.[Repository] WHERE RepId = T.[RepId])
INSERT INTO gam.[Application] ([RepId], [AppId], [AppName], [AppGUID], [AppVer], [AppComName], [AppTypeId], [AppParAppId], [AppDsc], [AppCopyright], [AppOrder], [AppRetMnuOptWithoutPrm], [AppCurEnvId], [AppBaseAppId], [AppCreDate], [AppCreUser], [AppUpdDate], [AppUpdUser], [AppIsBaseApplication], [AppCliId], [AppCliSecret], [AppCliUserGUID], [AppCliImageURL], [AppCliSiteURL], [AppCliSiteDomain], [AppCliRevoked], [AppType], [AppCliEncKey], [AppCliDefPrmGUID], [AppAccessReqPrm], [AppCliAccessUniqueByUser], [AppCliAutoRegAnomymousUser], [AppCliAllowRemoteAuth], [AppCliAllowGetUserRoles], [AppCliAllowGetUserAdditionalDa], [AppCliLocalLoginURL]) SELECT DISTINCT [RepId], [AppId], [AppName], [AppGUID], [AppVer], [AppComName], [AppTypeId], [AppParAppId], [AppDsc], [AppCopyright], [AppOrder], [AppRetMnuOptWithoutPrm], [AppCurEnvId], [AppBaseAppId], [AppCreDate], [AppCreUser], [AppUpdDate], [AppUpdUser], [AppIsBaseApplication], [AppCliId], [AppCliSecret], [AppCliUserGUID], [AppCliImageURL], [AppCliSiteURL], [AppCliSiteDomain], [AppCliRevoked], [AppType], [AppCliEncKey], [AppCliDefPrmGUID], [AppAccessReqPrm], [AppCliAccessUniqueByUser], [AppCliAutoRegAnomymousUser], NULL, NULL, NULL, NULL FROM gam.[Application] T WHERE NOT EXISTS (SELECT 1 FROM gam.[Application] WHERE RepId = T.[RepId] AND AppId = T.[AppId])
INSERT INTO gam.[AppEnvironment] ([RepId], [AppId], [AppEnvId], [AppEnvOrder], [AppEnvGUID], [AppEnvSrvHost], [AppEnvSrvPort], [AppEnvSrvVirDir], [AppEnvSrvHttps], [AppEnvSrvPgmPac], [AppEnvSrvPgmExt], [AppEnvName], [AppEnvCreDate], [AppEnvCreUser], [AppEnvUpdDate], [AppEnvUpdUser]) SELECT DISTINCT [RepId], [AppId], [AppCurEnvId], convert(int, 0), '', '', NULL, NULL, convert(bit, 0), NULL, NULL, NULL, NULL, NULL, convert( DATETIME, '17530101', 112 ), NULL FROM gam.[Application] T WHERE NOT EXISTS (SELECT 1 FROM gam.[AppEnvironment] WHERE RepId = T.[RepId] AND AppId = T.[AppId] AND AppEnvId = T.[AppCurEnvId]) AND (NOT [AppCurEnvId] IS NULL )
ALTER TABLE gam.[Application] ALTER COLUMN [AppCliSecret]  nchar(120) NULL
CREATE NONCLUSTERED INDEX [IAPPLICATIONENV] ON gam.[Application] ([RepId] ,[AppId] ,[AppCurEnvId] )

CREATE TABLE gam.[UserMemRoleProp] ([UserGUID]  nchar(40) NOT NULL , [RepId]  int NOT NULL , [UserMemRoleRoleId]  decimal( 12) NOT NULL , [UserMemRolePropId]  nchar(60) NOT NULL , [UserMemRolePropToken]  nchar(40) NOT NULL , [UserMemRolePropValue]  nvarchar(400) NOT NULL , PRIMARY KEY([UserGUID], [RepId], [UserMemRoleRoleId], [UserMemRolePropId], [UserMemRolePropToken]))

CREATE TABLE gam.[UserMemAppRoleProp] ([UserGUID]  nchar(40) NOT NULL , [RepId]  int NOT NULL , [UserMemAppRoleAppId]  decimal( 12) NOT NULL , [UserMemAppRoleRoleId]  decimal( 12) NOT NULL , [UserMemAppRolePropId]  nchar(60) NOT NULL , [UserMemAppRolePropToken]  nchar(40) NOT NULL , [UserMemAppRolePropValue]  nvarchar(400) NOT NULL , PRIMARY KEY([UserGUID], [RepId], [UserMemAppRoleAppId], [UserMemAppRoleRoleId], [UserMemAppRolePropId], [UserMemAppRolePropToken]))

CREATE TABLE gam.[SecurityPolicyProp] ([RepId]  int NOT NULL , [SecPolId]  int NOT NULL , [SecPolPropId]  nchar(60) NOT NULL , [SecPolPropToken]  nchar(40) NOT NULL , [SecPolPropValue]  nvarchar(400) NOT NULL , PRIMARY KEY([RepId], [SecPolId], [SecPolPropId], [SecPolPropToken]))

DROP INDEX [IUSERMEMAPPROLE1] ON gam.[UserMemAppRole]
CREATE NONCLUSTERED INDEX [IUSERMEMAPPROLEAPP] ON gam.[UserMemAppRole] ([RepId] ,[UserMemAppRoleAppId] )
CREATE NONCLUSTERED INDEX [IUSERMEMAPPROLEROLE] ON gam.[UserMemAppRole] ([RepId] ,[UserMemAppRoleRoleId] )

sp_rename 'gam.[SessionHistoryHisLogAtt]', 'SessionHistoryLogAtt'

UPDATE gam.[SysPar] SET [SysParVal]='3.0.6' WHERE [SysParId]='GAMVersion'
